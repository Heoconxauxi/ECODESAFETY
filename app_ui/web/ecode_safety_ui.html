<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>EcodeSafety Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    * { box-sizing: border-box; }
    :root {
      --bg-main: #0f172a;
      --bg-card: #020617;
      --bg-soft: #111827;
      --accent: #2563eb;
      --accent-soft: #1d4ed8;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d4ed8 0, #020617 45%);
      color: var(--text-main);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: 250px;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(18px);
      color: #e5e7eb;
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      border-right: 1px solid rgba(148, 163, 184, 0.2);
    }
    .sidebar h2 {
      margin: 0 0 18px;
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sidebar h2 span.logo-badge {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #06b6d4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      font-weight: 700;
      color: #0b1120;
    }
    .menu-group-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #64748b;
      margin: 8px 0 4px;
    }
    .menu-btn {
      padding: 10px 12px;
      border-radius: 12px;
      margin-bottom: 6px;
      cursor: pointer;
      color: #e5e7eb;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      transition: background 0.18s ease, transform 0.12s ease, box-shadow 0.12s ease;
    }
    .menu-main { display: flex; align-items: center; gap: 8px; }
    .menu-pill {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.16);
      color: #cbd5f5;
    }
    .menu-btn.active {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      box-shadow: 0 10px 26px rgba(37, 99, 235, 0.5);
      transform: translateY(-1px);
    }
    .menu-btn:hover { background: #0b1120; }

    .main {
      flex: 1;
      overflow-y: auto;
      padding: 18px 26px 24px;
      background: radial-gradient(circle at top, rgba(37, 99, 235, 0.32) 0, #020617 45%);
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 14px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
      margin-bottom: 14px;
    }
    header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    header h1 span.badge-beta {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(96, 165, 250, 0.2);
      color: #bfdbfe;
      border: 1px solid rgba(96, 165, 250, 0.5);
    }
    header small {
      display: block;
      color: var(--text-muted);
      font-size: 11px;
    }

    .user-box { display: flex; align-items: center; gap: 12px; position: relative; }
    #google-login-btn { display: block; }
    #user-info {
      display: none;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 999px;
      transition: background 0.18s, transform 0.1s;
      background: rgba(15, 23, 42, 0.7);
    }
    #user-info:hover {
      background: rgba(15, 23, 42, 1);
      transform: translateY(-1px);
    }
    .user-avatar {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #22c55e, #06b6d4);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #020617;
      text-transform: uppercase;
      font-size: 14px;
    }
    .user-text { display: flex; flex-direction: column; line-height: 1.2; }
    .user-text .name { font-size: 13px; font-weight: 500; }
    .user-text .email { font-size: 11px; color: #9ca3af; }
    .user-menu {
      position: absolute;
      top: 40px;
      right: 0;
      background: #020617;
      border-radius: 12px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.8);
      padding: 6px 0;
      min-width: 160px;
      display: none;
      z-index: 10;
      border: 1px solid rgba(51, 65, 85, 0.7);
    }
    .user-menu-item {
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #e5e7eb;
    }
    .user-menu-item:hover { background: #111827; }
    .user-menu-item.danger { color: #fecaca; }

    .card {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.96), #020617);
      padding: 18px 18px 16px;
      border-radius: 18px;
      box-shadow: 0 18px 48px rgba(15, 23, 42, 0.85);
      margin-bottom: 18px;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }
    .card h2 {
      margin: 0 0 4px;
      font-size: 17px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card small {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    textarea, input[type="text"], input[type="file"] {
      width: 100%;
      padding: 10px 11px;
      margin-top: 8px;
      border-radius: 12px;
      border: 1px solid #1e293b;
      font-size: 14px;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
      background: rgba(15, 23, 42, 0.8);
      color: #f9fafb;
    }
    textarea:focus, input[type="text"]:focus, input[type="file"]:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
      background: #020617;
    }
    textarea { resize: vertical; min-height: 80px; }

    button {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      cursor: pointer;
      margin-right: 8px;
      font-size: 14px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.12s ease;
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.45);
    }
    button.secondary {
      background: #111827;
      color: #e5e7eb;
      box-shadow: none;
      border: 1px solid rgba(55, 65, 81, 0.8);
    }
    button:disabled {
      opacity: 0.55;
      box-shadow: none;
      cursor: default;
    }
    button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.65);
    }

    .result {
      margin-top: 12px;
      padding: 10px;
      background: #020617;
      color: #e5e7eb;
      border-radius: 10px;
      display: none;
      white-space: pre-wrap;
      max-height: 260px;
      overflow-y: auto;
      font-size: 12px;
      font-family: "JetBrains Mono", "Fira Code", monospace;
      border: 1px solid #1e293b;
    }

    .tab-page { display: none; }
    .tab-page.active { display: block; }

    .additive-list {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .additive-card {
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.26), rgba(15, 23, 42, 0.95));
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      transition: transform 0.08s ease, box-shadow 0.12s ease, border-color 0.12s ease, background 0.12s;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    .additive-card::after {
      content: "Chi tiết ›";
      position: absolute;
      right: 10px;
      top: 10px;
      font-size: 11px;
      color: #bfdbfe;
      opacity: 0.75;
    }
    .additive-card:hover {
      transform: translateY(-1px) scale(1.005);
      border-color: #60a5fa;
      box-shadow: 0 14px 32px rgba(15, 23, 42, 0.75);
      background: radial-gradient(circle at top left, rgba(96, 165, 250, 0.4), #020617);
    }
    .add-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 2px;
      color: #e5e7eb;
    }
    .add-line {
      font-size: 13px;
      color: #cbd5f5;
      margin-top: 2px;
    }
    .add-line.muted {
      font-size: 12px;
      color: #9ca3af;
    }
    .add-tags {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .tag-chip {
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.25);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      font-weight: 500;
      margin-right: 4px;
    }
    .badge-pill.green {
      background: rgba(22, 163, 74, 0.18);
      color: #bbf7d0;
      border: 1px solid rgba(22, 163, 74, 0.7);
    }
    .badge-pill.yellow {
      background: rgba(202, 138, 4, 0.18);
      color: #fef3c7;
      border: 1px solid rgba(202, 138, 4, 0.7);
    }
    .badge-pill.red {
      background: rgba(185, 28, 28, 0.18);
      color: #fecaca;
      border: 1px solid rgba(185, 28, 28, 0.7);
    }
    .badge-pill.gray {
      background: rgba(148, 163, 184, 0.24);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .history-block {
      background: #020617;
      color: #e5e7eb;
      padding: 10px 12px;
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.12s, transform 0.08s, border 0.12s;
      border: 1px solid rgba(55, 65, 81, 0.85);
    }
    .history-block:hover {
      background: #020617;
      transform: translateY(-1px);
      border-color: #60a5fa;
    }
    .history-header-line {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 13px;
    }
    .history-ecodes {
      font-weight: 600;
      color: #bfdbfe;
    }
    .history-time {
      font-size: 11px;
      opacity: 0.9;
      white-space: nowrap;
      color: #e5e7eb;
    }
    .history-source-text {
      margin-top: 4px;
      font-size: 12px;
      opacity: 0.9;
      color: #9ca3af;
    }
    .history-detail {
      display: none;
      background: #020617;
      margin-top: 8px;
      padding: 8px 9px;
      border-radius: 10px;
      border: 1px dashed rgba(75, 85, 99, 0.9);
    }
    .history-add-card {
      border-bottom: 1px solid rgba(148, 163, 184, 0.35);
      padding: 6px 0;
      font-size: 12px;
      cursor: pointer;
    }
    .history-add-card:last-child { border-bottom: none; }
    .history-add-card:hover { background: #020617; }

    /* ====== NEW: Image cropper styles ====== */
    .image-cropper {
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      border: 1px dashed rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.7);
    }
    #imageCanvas {
      display: block;
      border-radius: 10px;
      border: 1px solid rgba(30, 64, 175, 0.8);
      background: #020617;
      cursor: crosshair;

      /* KHÔNG ép kích thước canvas bằng CSS */
      width: auto !important;
      height: auto !important;
      max-width: 100%;
    }
    .crop-hint {
      margin-top: 6px;
      font-size: 11px;
      color: #9ca3af;
    }
    .crop-actions {
      margin-top: 6px;
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 11px;
      color: #9ca3af;
    }
    .crop-actions button.secondary {
      padding: 4px 10px;
      font-size: 11px;
      border-radius: 999px;
    }

    /* ====== NEW: Additive Detail Dialog Styles (from additive_detail.html) ====== */
    .dialog-overlay {
      display: none; /* Mặc định ẩn */
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(5px);
      align-items: center;
      justify-content: center;
      z-index: 1000; /* Luôn nổi lên trên */
    }
    .dialog-content {
      max-width: 600px;
      margin: 40px auto;
      background: #0f172a;
      padding: 26px 30px;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 22px 52px rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    .dialog-close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      transition: color 0.15s;
    }
    .dialog-close-btn:hover {
      color: #f1f5f9;
    }
    
    /* Styles for additive detail content */
    .detail-h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #f1f5f9;
    }
    .detail-code-pill {
      padding: 4px 14px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.45);
      font-size: 15px;
      font-weight: 600;
    }
    .detail-meta {
      margin-top: 10px;
      font-size: 16px;
      line-height: 1.55;
      color: #d1d5db;
    }
    .detail-section-title {
      margin-top: 28px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #94a3b8;
      font-weight: 600;
    }
    .detail-info-box {
      margin-top: 12px;
      background: radial-gradient(circle at top, rgba(59, 130, 246, 0.28), #020617);
      padding: 16px;
      border-radius: 14px;
      line-height: 1.6;
      border: 1px solid rgba(37, 99, 235, 0.65);
      font-size: 15px;
      min-height: 60px;
    }
    .detail-tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(148,163,184,0.25);
      color: #e5e7eb;
      font-size: 13px;
      margin-right: 6px;
      margin-top: 6px;
      border: 1px solid rgba(148, 163, 184, 0.45);
    }
    .detail-risk-pill {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 13px;
      margin-left: 6px;
    }
    .risk-green { background: rgba(22,163,74,0.25); border:1px solid rgba(22,163,74,0.6); color:#bbf7d0; }
    .risk-yellow { background: rgba(202,138,4,0.25); border:1px solid rgba(202,138,4,0.6); color:#fef3c7; }
    .risk-red { background: rgba(185,28,28,0.25); border:1px solid rgba(185,28,28,0.6); color:#fecaca; }
    .risk-gray { background: rgba(148,163,184,0.25); border:1px solid rgba(148,163,184,0.6); color:#e5e7eb; }
    .detail-source {
      margin-top: 8px;
      padding: 4px 10px;
      background: rgba(148,163,184,0.15);
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.45);
      font-size: 13px;
      display: inline-block;
      color: #cbd5e1;
    }
    .detail-loading {
      font-size: 13px;
      color: #9ca3af;
      margin-top: 6px;
    }
  </style>
</head>

<body>

<div class="sidebar">
  <h2>
    <span class="logo-badge">CS</span>
    <span>CodeSafety</span>
  </h2>

  <div class="menu-btn active" data-tab="text" onclick="setActiveTab('text')">
    <div class="menu-main"><span>Phân tích - Nhập</span></div>
    <span class="menu-pill">Text</span>
  </div>

  <div class="menu-btn" data-tab="image" onclick="setActiveTab('image')">
    <div class="menu-main"><span>Phân tích - Ảnh</span></div>
    <span class="menu-pill">OCR</span>
  </div>

  <div class="menu-btn" data-tab="search" onclick="setActiveTab('search')">
    <div class="menu-main"><span>Tìm kiếm</span></div>
    <span class="menu-pill">Lookup</span>
  </div>

  <div class="menu-btn" data-tab="history" onclick="setActiveTab('history')">
    <div class="menu-main"><span>Lịch sử</span></div>
    <span class="menu-pill">Recent</span>
  </div>
</div>

<div class="main">
  <header>
    <div>
      <h1>
        Hệ thống phân tích phụ gia thực phẩm
        <span class="badge-beta">• Neo4j</span>
      </h1>
      <small>Nhập thành phần / chụp ảnh → hệ thống chuẩn hóa & đối chiếu phụ gia theo INS/E-code.</small>
    </div>

    <div class="user-box">
      <div id="google-login-btn"></div>
      <div id="user-info">
        <div id="user-avatar" class="user-avatar"></div>
        <div class="user-text">
          <span id="user-name" class="name"></span>
          <span id="user-email" class="email"></span>
        </div>
      </div>
      <div id="user-menu" class="user-menu">
        <div class="user-menu-item">Tài khoản</div>
        <div class="user-menu-item danger" onclick="logout()">Đăng xuất</div>
      </div>
    </div>
  </header>

  <div id="tab-text" class="tab-page active">
    <div class="card">
      <h2>Phân tích TEXT</h2>
      <small>Nhập thành phần sản phẩm, hệ thống sẽ trích E-code, tra Neo4j & áp rule.</small>

      <textarea id="inputText" rows="4" placeholder="VD: Thành phần: E100, E621..."></textarea>

      <div style="margin-top:8px;">
        <button id="btnAnalyzeText" onclick="analyzeText()">Phân tích TEXT</button>
        <button class="secondary"
                onclick="clearContainer('textResult');clearResultAndCache('textResult');
                clearContainer('resultText');clearContainer('sourceTextBlock')">
          Xoá kết quả
        </button>
      </div>

      <div id="textResult" class="additive-list"></div>
      <div id="resultText" class="result"></div>

      <div id="sourceTextBlock" class="result" style="margin-top:8px;display:none;"></div>
    </div>
  </div>

  <div id="tab-image" class="tab-page">
    <div class="card">
      <h2>Phân tích Ảnh</h2>
      <small>Upload ảnh nhãn sản phẩm. Bạn có thể crop vùng “Thành phần” trước OCR.</small>

      <input type="file" id="imageFile" accept="image/*" onchange="handleImageFileChange(event)">

      <div class="image-cropper">
        <canvas id="imageCanvas"></canvas>

        <div class="crop-hint">
          1️.Chọn ảnh → 2️.Kéo vùng cần crop (Thành phần).  
          Nếu không crop, hệ thống sẽ phân tích toàn ảnh.
        </div>

        <div class="crop-actions">
          <button type="button" class="secondary" onclick="resetCropSelection()">Xoá vùng crop</button>
          <span id="cropStatusText">Chưa chọn vùng crop.</span>
        </div>
      </div>

      <div style="margin-top:8px;">
        <button id="btnAnalyzeImage" onclick="analyzeImage()">Phân tích Ảnh</button>
        <button class="secondary"
                onclick="clearContainer('imageResult');clearResultAndCache('imageResult');
                clearContainer('resultImage');clearContainer('sourceImageBlock')">
          Xoá kết quả
        </button>
      </div>

      <div id="sourceImageBlock" class="result" style="margin-top:8px;display:none;"></div>
      <div id="imageResult" class="additive-list"></div>
      <div id="resultImage" class="result"></div>
    </div>
  </div>

  <div id="tab-search" class="tab-page">
    <div class="card">
      <h2>Tìm kiếm phụ gia</h2>
      <small>Tìm theo mã INS, tên tiếng Anh hoặc tiếng Việt. Nhấn vào kết quả để xem chi tiết.</small>
      <input type="text" id="searchBox" placeholder="Nhập E100, Curcumin, Tinh nghệ...">
      <div style="margin-top:8px;">
        <button id="btnSearch" onclick="searchAdditives()">Tìm kiếm</button>
        <button class="secondary" onclick="clearContainer('searchResult');clearResultAndCache('searchResult');clearContainer('resultSearch')">Xoá kết quả</button>
      </div>
      <div id="searchResult" class="additive-list"></div>
      <div id="resultSearch" class="result"></div>
    </div>
  </div>

  <div id="tab-history" class="tab-page">
    <div class="card">
      <h2>Lịch sử phân tích</h2>
      <small>Mỗi block tương ứng 1 lần phân tích. Nhấn để xem chi tiết.</small>
      <div style="margin-top:8px;">
        <button id="btnHistory" onclick="loadHistory()">Tải lịch sử</button>
        <button class="secondary" onclick="clearContainer('historyResult')">Xoá kết quả</button>
      </div>
      <div id="historyResult" style="margin-top:12px;"></div>
    </div>
  </div>
  
  <div id="historyDialog" 
      style="display:none; position:fixed; 
              left:0;top:0;width:100%;height:100%;
              background:rgba(0,0,0,0.6); 
              backdrop-filter: blur(4px);
              align-items:center;justify-content:center;
              z-index: 999;">

    <div style="background:#0f172a;padding:20px;border-radius:14px;
                width:480px;max-height:80vh;overflow-y:auto;
                border:1px solid #334155;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <h3 style="margin:0;font-size:18px;">Chi tiết lịch sử</h3>
          <button onclick="closeHistoryDialog()" 
                  style="
                  background:none;
                  border:none;
                  color:#e5e7eb;
                  font-size:18px;
                  cursor:pointer;
                  padding:4px 8px;
                  ">✕</button>
        </div>  

        <div id="dialogSourceText"
            style="white-space:pre-wrap;font-size:13px;
                    background:#1e293b;padding:10px;border-radius:8px;margin-bottom:10px;">
        </div>

        <div id="dialogAdditiveContainer"></div>
    </div>
  </div>

  <div id="additiveDetailDialog" class="dialog-overlay">
    <div class="dialog-content">
      <button class="dialog-close-btn" onclick="closeAdditiveDetailDialog()">✕</button>
      <div id="additiveDetailContent">
        </div>
    </div>
  </div>

</div>

<script>
const API_BASE = "https://flf3p194-8000.asse.devtunnels.ms";
const DEFAULT_SOURCE_LINK = "https://drive.google.com/file/d/1U-8MHPgdF5Epht0MPbcb4J8ZtqL9z8Bw/view?usp=sharing"
let ACCESS_TOKEN = null;
let userMenuVisible = false;

const CACHE_TAB_KEY = "CACHE_LAST_TAB";
const CACHE_CONTAINER_KEY = "CACHE_LAST_CONTAINER";
const CACHE_DATA_KEY = "CACHE_LAST_DATA";

/* ==== Biến toàn cục cho crop ảnh ==== */
let imageCanvas = null;
let imageCtx = null;
let originalImage = null;      // ảnh đã load vào canvas
let selection = null;          // {x, y, w, h} theo toạ độ canvas
let isSelecting = false;
let startX = 0, startY = 0;

function saveCache(tab, containerId, list) {
  try {
    localStorage.setItem(CACHE_TAB_KEY, tab);
    localStorage.setItem(CACHE_CONTAINER_KEY, containerId);
    localStorage.setItem(CACHE_DATA_KEY, JSON.stringify(list || []));
  } catch (e) {}
}

function clearCacheIfContainer(containerId) {
  try {
    const last = localStorage.getItem(CACHE_CONTAINER_KEY);
    if (last === containerId) {
      localStorage.removeItem(CACHE_TAB_KEY);
      localStorage.removeItem(CACHE_CONTAINER_KEY);
      localStorage.removeItem(CACHE_DATA_KEY);
    }
  } catch (e) {}
}

function clearResultAndCache(containerId) {
  clearCacheIfContainer(containerId);
}

function setActiveTab(id) {
  document.querySelectorAll(".menu-btn").forEach(btn => {
    const tab = btn.getAttribute("data-tab");
    if (tab === id) btn.classList.add("active");
    else btn.classList.remove("active");
  });

  document.querySelectorAll(".tab-page").forEach(p => p.classList.remove("active"));
  const page = document.getElementById("tab-" + id);
  if (page) page.classList.add("active");
}

window.onload = function () {
  const tk = localStorage.getItem("ACCESS_TOKEN");
  if (tk) {
    ACCESS_TOKEN = tk;
    const name = localStorage.getItem("USER_NAME") || "User";
    const email = localStorage.getItem("USER_EMAIL") || "";
    document.getElementById("google-login-btn").style.display = "none";
    document.getElementById("user-info").style.display = "flex";
    setUserUI(name, email);
  }

  google.accounts.id.initialize({
    client_id: "249383931866-a7m46i32lsoagdvs5u0pdp0sgd86ha9m.apps.googleusercontent.com",
    callback: handleGoogleLogin
  });

  google.accounts.id.renderButton(
    document.getElementById("google-login-btn"),
    { theme: "outline", size: "medium", text: "signin_with" }
  );

  document.getElementById("user-info").addEventListener("click", function (e) {
    e.stopPropagation();
    userMenuVisible = !userMenuVisible;
    document.getElementById("user-menu").style.display = userMenuVisible ? "block" : "none";
  });

  document.addEventListener("click", function () {
    if (userMenuVisible) {
      userMenuVisible = false;
      document.getElementById("user-menu").style.display = "none";
    }
  });

  /* ==== Khởi tạo canvas crop ==== */
  initImageCropper();
};

function setUserUI(name, email) {
  const avatar = document.getElementById("user-avatar");
  avatar.style.display = "flex";
  avatar.innerText = (name || "?").charAt(0).toUpperCase();

  document.getElementById("user-name").innerText = name || "Người dùng";
  document.getElementById("user-email").innerText = email || "";
}

async function handleGoogleLogin(res) {
  const response = await fetch(API_BASE + "/auth/google-login", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ id_token: res.credential })
  });

  const data = await response.json();
  ACCESS_TOKEN = data.access_token;

  localStorage.setItem("ACCESS_TOKEN", ACCESS_TOKEN);
  localStorage.setItem("USER_NAME", data.user.name);
  localStorage.setItem("USER_EMAIL", data.user.email);

  document.getElementById("google-login-btn").style.display = "none";
  document.getElementById("user-info").style.display = "flex";
  setUserUI(data.user.name, data.user.email);
}

function logout() {
  localStorage.clear();
  ACCESS_TOKEN = null;
  location.reload();
}

function showJson(id, data) {
  const el = document.getElementById(id);
  if (!el) return;
  el.style.display = "block";
  el.innerText = JSON.stringify(data, null, 2);
}
function clearContainer(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.innerHTML = "";
  if (el.classList.contains("result")) {
    el.style.display = "none";
  }
}

function getRiskBadge(level, isDetail = false) {
  const pillClass = isDetail ? 'detail-risk-pill' : 'badge-pill';
  if (level === 1 || level === "1") {
    return `<span class="${pillClass} risk-green">VS - Very Safe</span>`;
  }
  if (level === 2 || level === "2") {
    return `<span class="${pillClass} risk-yellow">SL - Safe w/ Limits</span>`;
  }
  if (level === 4 || level === "4") {
    return `<span class="${pillClass} risk-red">BT - Banned / Toxic</span>`;
  }
  return `<span class="${pillClass} risk-gray">N/A</span>`;
}

function getRuleBadge(rule, isDetail = false) {
  const pillClass = isDetail ? 'detail-risk-pill' : 'badge-pill';
  if (rule === 1 || rule === "1") {
    return `<span class="${pillClass} risk-green">VS - Very Safe</span>`;
  }
  if (rule === 2 || rule === "2") {
    return `<span class="${pillClass} risk-yellow">SL - Safe w/ Limits</span>`;
  }
  if (rule === 4 || rule === "4") {
    return `<span class="${pillClass} risk-red">BT - Banned / Toxic</span>`;
  }
  return `<span class="${pillClass} risk-gray">N/A</span>`;
}

/* ==== NEW: HÀM MỞ VÀ ĐÓNG DIALOG CHI TIẾT PHỤ GIA ==== */
function closeAdditiveDetailDialog() {
  document.getElementById("additiveDetailDialog").style.display = "none";
}

async function openAdditiveDetailDialog(additive) {
  if (!additive || !additive.ins) return;

  const dialog = document.getElementById("additiveDetailDialog");
  const content = document.getElementById("additiveDetailContent");
  
  // Hiển thị skeleton/loading ban đầu
  content.innerHTML = `
      <h1 class="detail-h1">${additive.name || "Không rõ tên"}
        <span class="detail-code-pill">${additive.ins}</span>
      </h1>
      <div class="detail-meta"><b>Tên tiếng Việt:</b> ${additive.name_vn || "—"}</div>
      <div class="detail-meta"><b>ADI:</b> ${additive.adi || "—"}</div>
      <div class="detail-meta"><b>Trạng thái:</b> ${additive.status_vn || "—"}</div>
      <div class="detail-meta"><b>Mức nguy cơ:</b> ${getRiskBadge(additive.level, true)}</div>
      <div class="detail-meta"><b>Rule Engine:</b> ${getRuleBadge(additive.rule_risk, true)}</div>

      <div class="detail-section-title">Chức năng</div>
      <div>
        ${
          (additive.functions && additive.functions.length)
            ? additive.functions.map(f => `<span class="detail-tag">${f}</span>`).join("")
            : "<span style='color:#94a3b8'>Không có thông tin chức năng.</span>"
        }
      </div>

      <div class="detail-section-title">Thông tin</div>
      <div class="detail-info-box">Đang tải mô tả chi tiết...</div>
      <div class="detail-loading">Đang tải mô tả AI...</div>
      
      <div class="detail-section-title">Nguồn</div>
      <div class="detail-source">Chưa có dữ liệu nguồn.</div>
  `;
  dialog.style.display = "flex";

  // Gọi API để lấy thông tin chi tiết (bao gồm mô tả AI)
  try {
    const res = await fetch(API_BASE + "/ecodes/info?ins=" + encodeURIComponent(additive.ins));
    const data = await res.json();

    if (!res.ok) {
      // Cập nhật chỉ phần info box nếu lỗi API
      content.querySelector('.detail-info-box').innerHTML = 
        `<span style='color:#fecaca'>Lỗi khi tải chi tiết: ${data.detail || "E-code không tồn tại"}</span>`;
      content.querySelector('.detail-loading').style.display = 'none';
      return;
    }

    // Render lại toàn bộ nội dung với dữ liệu đầy đủ
    const functions = data.functions || [];
    const info = data.info || "Không có mô tả chi tiết.";

    // BẮT ĐẦU PHẦN CẦN SỬA ĐỔI ĐỂ HIỂN THỊ CẢ HAI LINK VỚI TEXT MỚI
    const apiSource = data.source || "";
    const isApiSourceUrl = apiSource.toLowerCase().includes("http");
    
    // Link mặc định mới: Thông tư Việt Nam
    const defaultLinkHtml = `<a href="${DEFAULT_SOURCE_LINK}" target="_blank" style="color:#60a5fa; text-decoration:underline; display:block;">Thông tư Việt Nam</a>`;
    
    let apiLinkHtml = "";
    
    // Nếu có nguồn từ API và đó là URL hợp lệ, thì hiển thị là WHO | JECFA
    if (isApiSourceUrl) {
        apiLinkHtml = `<a href="${apiSource}" target="_blank" style="color:#60a5fa; text-decoration:underline; display:block; margin-bottom: 5px;">WHO | JECFA</a>`;
    }

    // Kết hợp cả hai link (Link API/WHO | JECFA sẽ đứng trước nếu nó tồn tại)
    const sourceLinkHtml = apiLinkHtml + defaultLinkHtml;

    document.getElementById("additiveDetailContent").innerHTML = `
        <h1 class="detail-h1">${data.name || "Không rõ tên"}
          <span class="detail-code-pill">${data.ins || ""}</span>
        </h1>

        <div class="detail-meta"><b>Tên tiếng Việt:</b> ${data.name_vn || "—"}</div>
        <div class="detail-meta"><b>ADI:</b> ${data.adi || "—"}</div>
        <div class="detail-meta"><b>Trạng thái:</b> ${data.status_vn || "Được phép tại Việt Nam" || "Không được phép tại Việt Nam"}</div>
        <div class="detail-meta"><b>Mức nguy cơ:</b> ${getRiskBadge(data.level, true)}</div>
        <div class="detail-meta"><b>Rule Engine:</b> ${getRuleBadge(data.rule_risk, true)}</div>

        <div class="detail-section-title">Chức năng</div>
        <div>
          ${
            functions.length
              ? functions.map(f => `<span class="detail-tag">${f}</span>`).join("")
              : "<span style='color:#94a3b8'>Không có thông tin chức năng.</span>"
          }
        </div>

        <div class="detail-section-title">Thông tin</div>
        <div class="detail-info-box">
          ${info}
        </div>

        <div class="detail-section-title">Nguồn</div>
        <div class="detail-source">
          ${sourceLinkHtml}
        </div>
    `;

  } catch (err) {
    content.querySelector('.detail-info-box').innerHTML = 
        `<span style='color:#fecaca'>Lỗi mạng: ${String(err)}</span>`;
    content.querySelector('.detail-loading').style.display = 'none';
  }
}

function renderAdditivesForIngredient(containerId, ecodesFound) {
  const box = document.getElementById(containerId);
  if (!box) return;
  box.innerHTML = "";

  if (!ecodesFound || ecodesFound.length === 0) {
    box.innerHTML = '<div style="font-size:13px;color:#9ca3af;">Không tìm thấy phụ gia nào.</div>';
    return;
  }

  ecodesFound.forEach(e => {
    const functions = e.functions || e.function || [];
    const riskBadge = getRiskBadge(e.level);
    const ruleBadge = getRuleBadge(e.rule_risk);
    const statusText = e.status_vn || "Được phép tại Việt Nam";

    const card = document.createElement("div");
    card.className = "additive-card";
    card.innerHTML = `
      <div class="add-title">${e.ins || "N/A"} – ${e.name || ""}</div>
      <div class="add-line"><b>VN:</b> ${e.name_vn || "—"}</div>
      <div class="add-line"><b>ADI:</b> ${e.adi || "—"}</div>
      <div class="add-line"><b>Status:</b> ${statusText}</div>
      <div class="add-line">
        <b>Risk:</b> ${riskBadge}
        <b>Rule:</b> ${ruleBadge}
      </div>
      <div class="add-line muted">Nhấn để xem chi tiết</div>
      <div class="add-tags">
        ${
          (functions && functions.length)
            ? functions.map(f => `<span class="tag-chip">${f}</span>`).join("")
            : '<span class="tag-chip">No function tag</span>'
        }
      </div>
    `;

    // Cập nhật sự kiện click để mở dialog
    card.onclick = () => {
      openAdditiveDetailDialog(e);
    };

    box.appendChild(card);
  });
}

function renderAdditivesForSearch(containerId, items) {
  const box = document.getElementById(containerId);
  if (!box) return;
  box.innerHTML = "";

  if (!items || items.length === 0) {
    box.innerHTML = '<div style="font-size:13px;color:#9ca3af;">Không tìm thấy phụ gia nào.</div>';
    return;
  }

  items.forEach(e => {
    const functions = e.functions || e.function || [];
    const riskBadge = getRiskBadge(e.level);
    const statusText = e.status_vn || "Được phép tại Việt Nam";

    const card = document.createElement("div");
    card.className = "additive-card";
    card.innerHTML = `
      <div class="add-title">${e.ins || "N/A"} – ${e.name || ""}</div>
      <div class="add-line"><b>VN:</b> ${e.name_vn || "—"}</div>
      <div class="add-line"><b>ADI:</b> ${e.adi || "—"}</div>
      <div class="add-line"><b>Status:</b> ${statusText}</div>
      <div class="add-line">
        <b>Risk:</b> ${riskBadge}
        <b>Rule:</b> ${getRuleBadge(e.rule_risk)}
      </div>
      <div class="add-line muted">Nhấn để xem chi tiết</div>
      <div class="add-tags">
        ${
          (functions && functions.length)
            ? functions.map(f => `<span class="tag-chip">${f}</span>`).join("")
            : '<span class="tag-chip">No function tag</span>'
        }
      </div>
    `;
    // Cập nhật sự kiện click để mở dialog
    card.onclick = () => openAdditiveDetailDialog(e);
    box.appendChild(card);
  });
}

async function analyzeText() {
  const text = document.getElementById("inputText").value.trim();
  if (!text) return alert("Chưa nhập nội dung!");

  const btn = document.getElementById("btnAnalyzeText");
  btn.disabled = true;
  btn.innerText = "Đang phân tích...";

  try {
    const headers = {"Content-Type": "application/json"};
    if (ACCESS_TOKEN) headers["Authorization"] = "Bearer " + ACCESS_TOKEN;

    const res = await fetch(API_BASE + "/ecode/analyze", {
      method: "POST",
      headers,
      body: JSON.stringify({input_text: text})
    });

    const data = await res.json();
    if (!res.ok) {
      showJson("resultText", data);
      const b = document.getElementById("sourceTextBlock");
      b.style.display = "none";
      b.innerText = "";
      return;
    }

    const list = data.ecodes_found || [];
    saveCache("text", "textResult", list);
    renderAdditivesForIngredient("textResult", list); 

    const b = document.getElementById("sourceTextBlock");
    if (data.source_text) {
      b.style.display = "block";
      b.innerText = "SOURCE TEXT (TEXT INPUT):\n" + data.source_text;
    } else {
      b.style.display = "none";
      b.innerText = "";
    }

  } catch (err) {
    showJson("resultText", { error: String(err) });
    const b = document.getElementById("sourceTextBlock");
    b.style.display = "none";
    b.innerText = "";
  } finally {
    btn.disabled = false;
    btn.innerText = "Phân tích TEXT";
  }
}

/* ==== Hỗ trợ load ảnh & crop ==== */
function initImageCropper() {
  imageCanvas = document.getElementById("imageCanvas");
  if (!imageCanvas) return;
  imageCtx = imageCanvas.getContext("2d");

  imageCanvas.addEventListener("mousedown", onCanvasMouseDown);
  imageCanvas.addEventListener("mousemove", onCanvasMouseMove);
  window.addEventListener("mouseup", onCanvasMouseUp);
  updateCropStatusText();
}

function handleImageFileChange(event) {
  const file = event.target.files[0];
  if (!file) {
    originalImage = null;
    clearCanvas();
    selection = null;
    updateCropStatusText();
    return;
  }

  const reader = new FileReader();
  reader.onload = function (e) {
    const img = new Image();
    img.onload = function () {
      originalImage = img;
      // scale ảnh vào canvas cho vừa UI
      const containerWidth = imageCanvas.parentElement.clientWidth - 20; // chừa padding
      let w = img.width;
      let h = img.height;

      // scale theo WIDTH container
      const ratio = containerWidth / w;
      w = Math.round(w * ratio);
      h = Math.round(h * ratio);

      // gán lại canvas đúng tỷ lệ
      imageCanvas.width = w;
      imageCanvas.height = h;

      // vẽ ảnh giữ nguyên tỷ lệ
      imageCtx.clearRect(0, 0, w, h);
      imageCtx.drawImage(img, 0, 0, w, h);

      originalImage = img;
      selection = null;
      updateCropStatusText();

      selection = null;
      updateCropStatusText();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function clearCanvas() {
  if (!imageCanvas || !imageCtx) return;
  imageCtx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
}

function onCanvasMouseDown(e) {
  if (!originalImage || !imageCanvas) return;
  const rect = imageCanvas.getBoundingClientRect();
  startX = e.clientX - rect.left;
  startY = e.clientY - rect.top;
  isSelecting = true;
  selection = { x: startX, y: startY, w: 0, h: 0 };
}

function onCanvasMouseMove(e) {
  if (!isSelecting || !originalImage || !imageCanvas) return;
  const rect = imageCanvas.getBoundingClientRect();
  const currentX = e.clientX - rect.left;
  const currentY = e.clientY - rect.top;
  selection.w = currentX - startX;
  selection.h = currentY - startY;
  redrawImageWithSelection();
}

function onCanvasMouseUp() {
  if (!isSelecting) return;
  isSelecting = false;
  normalizeSelection();
  redrawImageWithSelection();
  updateCropStatusText();
}

function normalizeSelection() {
  if (!selection) return;
  let { x, y, w, h } = selection;
  if (w < 0) {
    x = x + w;
    w = Math.abs(w);
  }
  if (h < 0) {
    y = y + h;
    h = Math.abs(h);
  }
  // clamp trong canvas
  x = Math.max(0, Math.min(x, imageCanvas.width));
  y = Math.max(0, Math.min(y, imageCanvas.height));
  if (x + w > imageCanvas.width) w = imageCanvas.width - x;
  if (y + h > imageCanvas.height) h = imageCanvas.height - y;

  selection = { x, y, w, h };
}

function redrawImageWithSelection() {
  if (!originalImage || !imageCanvas || !imageCtx) return;
  imageCtx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
  imageCtx.drawImage(originalImage, 0, 0, imageCanvas.width, imageCanvas.height);

  if (selection && selection.w && selection.h) {
    imageCtx.save();
    imageCtx.strokeStyle = "#3b82f6";
    imageCtx.lineWidth = 2;
    imageCtx.setLineDash([6, 3]);
    imageCtx.strokeRect(selection.x, selection.y, selection.w, selection.h);
    imageCtx.restore();
  }
}

function resetCropSelection() {
  selection = null;
  redrawImageWithSelection();
  updateCropStatusText();
}

function updateCropStatusText() {
  const el = document.getElementById("cropStatusText");
  if (!el) return;
  if (selection && selection.w > 10 && selection.h > 10) {
    el.textContent = `Đã chọn vùng crop: ${Math.round(selection.w)} x ${Math.round(selection.h)} px (theo canvas).`;
  } else {
    el.textContent = "Chưa chọn vùng crop.";
  }
}

/* ==== Sử dụng crop (nếu có) khi gửi ảnh lên API ==== */
async function analyzeImage() {
  const fileInput = document.getElementById("imageFile");
  const file = fileInput.files[0];
  if (!file) return alert("Chưa chọn ảnh!");

  const btn = document.getElementById("btnAnalyzeImage");
  btn.disabled = true;
  btn.innerText = "Đang phân tích...";

  try {
    let blobToSend = file;

    // Nếu có vùng crop hợp lệ & đã load ảnh lên canvas
    if (
      originalImage &&
      imageCanvas &&
      imageCtx &&
      selection &&
      selection.w > 10 &&
      selection.h > 10
    ) {
      // Chuẩn hoá lại selection (đảm bảo w,h dương)
      normalizeSelection();
      const { x, y, w, h } = selection;

      // Tạo canvas tạm để cắt vùng
      const cropCanvas = document.createElement("canvas");
      cropCanvas.width = w;
      cropCanvas.height = h;
      const cropCtx = cropCanvas.getContext("2d");

      // Cắt từ canvas hiện tại (đã scale) là đủ cho OCR
      cropCtx.drawImage(
        imageCanvas,
        x, y, w, h,
        0, 0, w, h
      );

      // Chuyển sang Blob (PNG) để gửi
      blobToSend = await new Promise((resolve) => {
        cropCanvas.toBlob((blob) => {
          resolve(blob || file);
        }, "image/png");
      });
    }

    const form = new FormData();
    // Giữ nguyên tên file nếu có, hoặc đặt tên mặc định
    form.append("image_file", blobToSend, file ? file.name : "crop.png");

    const headers = {};
    if (ACCESS_TOKEN) headers["Authorization"] = "Bearer " + ACCESS_TOKEN;

    const res = await fetch(API_BASE + "/ecode/analyze_image", {
      method: "POST",
      headers,
      body: form
    });

    const data = await res.json();
    if (!res.ok) {
      showJson("resultImage", data);
      const b = document.getElementById("sourceImageBlock");
      b.style.display = "none";
      b.innerText = "";
      return;
    }

    const list = data.ecodes_found || [];
    saveCache("image", "imageResult", list);
    renderAdditivesForIngredient("imageResult", list);

    const b = document.getElementById("sourceImageBlock");
    if (data.source_text) {
      b.style.display = "block";
      b.innerText = "SOURCE TEXT (OCR IMAGE):\n" + data.source_text;
    } else {
      b.style.display = "none";
      b.innerText = "";
    }

  } catch (err) {
    showJson("resultImage", { error: String(err) });
    const b = document.getElementById("sourceImageBlock");
    b.style.display = "none";
    b.innerText = "";
  } finally {
    btn.disabled = false;
    btn.innerText = "Phân tích Ảnh";
  }
}

async function searchAdditives() {
  const q = document.getElementById("searchBox").value.trim();
  const btn = document.getElementById("btnSearch");
  btn.disabled = true;
  btn.innerText = "Đang tìm kiếm ...";

  try {
    const url = API_BASE + "/ecodes/search?q=" + encodeURIComponent(q || "");
    const res = await fetch(url);
    const data = await res.json();

    if (!res.ok) {
      showJson("resultSearch", data);
      return;
    }

    const list = data.items || [];
    saveCache("search", "searchResult", list);
    renderAdditivesForSearch("searchResult", list);

  } catch (err) {
    showJson("resultSearch", { error: String(err) });
  } finally {
    btn.disabled = false;
    btn.innerText = "Search";
  }
}

async function loadHistory() {
  if (!ACCESS_TOKEN) return alert("Cần đăng nhập!");

  const btn = document.getElementById("btnHistory");
  btn.disabled = true;
  btn.innerText = "Đang tải...";

  try {
    const res = await fetch(API_BASE + "/users/me/history", {
      headers: {"Authorization": "Bearer " + ACCESS_TOKEN}
    });

    const data = await res.json();
    const container = document.getElementById("historyResult");
    container.innerHTML = "";

    if (!res.ok) {
      container.innerHTML = `<div style="color:#fecaca;font-size:13px;">Lỗi: ${data.detail || "Không thể tải lịch sử"}</div>`;
      return;
    }

    if (!data.items || data.items.length === 0) {
      container.innerHTML = '<div style="font-size:13px;color:#9ca3af;">Chưa có lịch sử phân tích.</div>';
      return;
    }

    data.items.forEach((item) => {
      const block = document.createElement("div");
      block.className = "history-block";
      block.innerHTML = `
        <div class="history-header-line">
          <div class="history-time">${new Date(item.analyzed_at).toLocaleString()}</div>
        </div>
        <div class="history-source-text">${item.source_text || ""}</div>
      `;
      
      block.onclick = () => {
          openHistoryDialog(item);
      };
      container.appendChild(block);
    }); 

  } catch (err) {
    const container = document.getElementById("historyResult");
    container.innerHTML = `<div style="color:#fecaca;font-size:13px;">Lỗi: ${String(err)}</div>`;
  } finally {
    btn.disabled = false;
    btn.innerText = "Tải lịch sử";
  }
}
function openHistoryDialog(item) {
    document.getElementById("historyDialog").style.display = "flex";

    const sourceTextDiv = document.getElementById("dialogSourceText");
    const container = document.getElementById("dialogAdditiveContainer");

    sourceTextDiv.innerHTML = "";
    sourceTextDiv.style.background = "#1e293b"; 
    sourceTextDiv.style.padding = "10px"; 

    let contentHtml = "";

    if (item.input_type === 'image' && item.source_image_b64) {
        contentHtml += `<img src="data:image/png;base64,${item.source_image_b64}" 
                         style="max-width:100%; height:auto; display:block; border-radius:6px; margin-bottom: 10px;">`;
        
        sourceTextDiv.style.background = "none";
        sourceTextDiv.style.padding = "10px";
        
        contentHtml += `<pre style="white-space:pre-wrap; margin:0; padding:10px; background:#020617; border-radius:8px; border: 1px solid #334155; color:#e5e7eb;">SOURCE TEXT (OCR):\n${item.source_text || "(Không có text OCR)"}</pre>`;
        
    } else {
        sourceTextDiv.style.background = "#1e293b"; 
        sourceTextDiv.style.padding = "10px";
        contentHtml += item.source_text || "(Không có source text)";
    }
    
    sourceTextDiv.innerHTML = contentHtml;


    container.innerHTML = "";

    if (item.additives && item.additives.length > 0) {
        item.additives.forEach(a => {
            const div = document.createElement("div");
            div.className = "additive-card";
            div.style.marginBottom = "10px";
            div.classList.add("no-detail-link"); 
            
            div.innerHTML = `
                <div class="add-title">${a.ins} – ${a.name || ""}</div>
                <div class="add-line">VN: ${a.name_vn || "—"}</div>
                <div class="add-line">ADI: ${a.adi || "—"}</div>
                <div class="add-line">Risk: ${getRiskBadge(a.level)}</div>
                <div class="add-line">Rule: ${getRuleBadge(a.rule_risk)}</div>
            `;

            div.onclick = (e) => {
                e.stopPropagation();
                openAdditiveDetailDialog(a);
            };
            container.appendChild(div);
        });
    } else {
        container.innerHTML = '<div style="font-size:12px;color:#94a3b8;">Không có additive nào.</div>';
    }
    
    let tempStyle = document.querySelector('[data-temp-style="true"]');
    if (!tempStyle) {
        tempStyle = document.createElement('style');
        tempStyle.setAttribute('data-temp-style', 'true');
        document.head.appendChild(tempStyle);
    }
    tempStyle.innerHTML = '.no-detail-link::after { content: none !important; }';
}

function closeHistoryDialog() {
    document.getElementById("historyDialog").style.display = "none";
    document.querySelector('[data-temp-style="true"]')?.remove();
}
</script>

</body>
</html>