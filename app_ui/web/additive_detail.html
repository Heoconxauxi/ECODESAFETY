<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chi tiết phụ gia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, sans-serif;
      background: radial-gradient(circle at top, #1d4ed8 0, #020617 45%);
      color: #e5e7eb;
      min-height: 100vh;
    }
    .container {
      max-width: 780px;
      margin: 40px auto;
      background: rgba(2, 6, 23, 0.85);
      padding: 26px 30px;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 22px 52px rgba(15, 23, 42, 0.85);
    }
    .back-btn {
      display: inline-block;
      padding: 8px 14px;
      border-radius: 10px;
      background: rgba(30, 41, 59, 0.9);
      color: #e5e7eb;
      text-decoration: none;
      border: 1px solid rgba(148, 163, 184, 0.45);
      transition: 0.15s;
      font-size: 14px;
      margin-bottom: 20px;
    }
    .back-btn:hover {
      background: #111827;
      transform: translateY(-1px);
    }
    h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #f1f5f9;
    }
    .code-pill {
      padding: 4px 14px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.45);
      font-size: 15px;
      font-weight: 600;
    }
    .meta {
      margin-top: 10px;
      font-size: 16px;
      line-height: 1.55;
      color: #d1d5db;
    }
    .section-title {
      margin-top: 28px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #94a3b8;
      font-weight: 600;
    }
    .info-box {
      margin-top: 12px;
      background: radial-gradient(circle at top, rgba(59, 130, 246, 0.28), #020617);
      padding: 16px;
      border-radius: 14px;
      line-height: 1.6;
      border: 1px solid rgba(37, 99, 235, 0.65);
      font-size: 15px;
      min-height: 60px;
    }
    .tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(148,163,184,0.25);
      color: #e5e7eb;
      font-size: 13px;
      margin-right: 6px;
      margin-top: 6px;
      border: 1px solid rgba(148, 163, 184, 0.45);
    }
    .risk-pill {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 13px;
      margin-left: 6px;
    }
    .risk-green { background: rgba(22,163,74,0.25); border:1px solid rgba(22,163,74,0.6); color:#bbf7d0; }
    .risk-yellow { background: rgba(202,138,4,0.25); border:1px solid rgba(202,138,4,0.6); color:#fef3c7; }
    .risk-red { background: rgba(185,28,28,0.25); border:1px solid rgba(185,28,28,0.6); color:#fecaca; }
    .risk-gray { background: rgba(148,163,184,0.25); border:1px solid rgba(148,163,184,0.6); color:#e5e7eb; }
    .source {
      margin-top: 8px;
      padding: 4px 10px;
      background: rgba(148,163,184,0.15);
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.45);
      font-size: 13px;
      display: inline-block;
      color: #cbd5e1;
    }
    .loading {
      font-size: 13px;
      color: #9ca3af;
      margin-top: 6px;
    }
  </style>
</head>

<body>
<div class="container">
  <a href="ecode_safety_ui.html" class="back-btn">← Quay về Dashboard</a>
  <div id="content">Đang tải dữ liệu…</div>
</div>

<script>
const API_BASE = "https://flf3p194-8000.asse.devtunnels.ms";

function riskLabel(level) {
  if (level == 1) return `<span class="risk-pill risk-green">VS - Very Safe</span>`;
  if (level == 2) return `<span class="risk-pill risk-yellow">SL - Safe w/ Limits</span>`;
  if (level == 4) return `<span class="risk-pill risk-red">BT - Banned / Toxic</span>`;
  return `<span class="risk-pill risk-gray">N/A</span>`;
}

function renderDetail(data, isFinal) {
  if (!data) {
    document.getElementById("content").innerHTML =
      "<div style='color:#fecaca'>Lỗi: Không có dữ liệu phụ gia.</div>";
    return;
  }

  const functions = data.functions || [];
  const info = data.info;
  const loadingInfo = isFinal ? "" : "<div class='loading'>Đang tải mô tả AI...</div>";

  document.getElementById("content").innerHTML = `
      <h1>${data.name || "Không rõ tên"}
        <span class="code-pill">${data.ins || ""}</span>
      </h1>

      <div class="meta"><b>Tên tiếng Việt:</b> ${data.name_vn || "—"}</div>
      <div class="meta"><b>ADI:</b> ${data.adi || "—"}</div>
      <div class="meta"><b>Trạng thái:</b> ${data.status_vn || "Được phép tại Việt Nam"}</div>
      <div class="meta"><b>Mức nguy cơ:</b> ${riskLabel(data.level)}</div>

      <div class="section-title">Chức năng</div>
      <div>
        ${
          functions.length
            ? functions.map(f => `<span class="tag">${f}</span>`).join("")
            : "<span style='color:#94a3b8'>Không có thông tin chức năng.</span>"
        }
      </div>

      <div class="section-title">Mô tả chi tiết (AI)</div>
      <div class="info-box">
        ${
          info
            ? info
            : "Chưa có mô tả AI cho phụ gia này."
        }
      </div>
      ${loadingInfo}

      <div class="section-title">Nguồn</div>
      <div class="source">
        ${data.source || "Chưa có dữ liệu nguồn."}
      </div>
  `;
}

async function loadDetail() {
  const params = new URLSearchParams(window.location.search);
  let ins = params.get("ins");

  let cached = null;
  try {
    cached = JSON.parse(localStorage.getItem("ADD_DETAIL") || "null");
  } catch (e) {}

  if (!ins && cached && cached.ins) {
    ins = cached.ins;
  }

  if (!ins) {
    document.getElementById("content").innerHTML =
      "<div style='color:#fecaca'>Lỗi: Không xác định được mã phụ gia (ins).</div>";
    return;
  }

  // Nếu có cached (từ list) thì render sơ bộ trước cho mượt
  if (cached && cached.ins === ins) {
    renderDetail(cached, false);
  } else {
    document.getElementById("content").innerHTML = "Đang tải dữ liệu phụ gia...";
  }

  try {
    const res = await fetch(API_BASE + "/ecodes/info?ins=" + encodeURIComponent(ins));
    const data = await res.json();

    if (!res.ok) {
      document.getElementById("content").innerHTML =
        "<div style='color:#fecaca'>Lỗi: " + (data.detail || "Không lấy được thông tin phụ gia") + "</div>";
      return;
    }

    // Cập nhật lại cache với bản đầy đủ (có info)
    try {
      localStorage.setItem("ADD_DETAIL", JSON.stringify(data));
    } catch (e) {}

    renderDetail(data, true);

  } catch (err) {
    document.getElementById("content").innerHTML =
      "<div style='color:#fecaca'>Lỗi khi gọi API: " + String(err) + "</div>";
  }
}

loadDetail();
</script>
</body>
</html>
